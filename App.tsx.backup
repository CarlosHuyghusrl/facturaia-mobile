/**
 * App.tsx - Main application entry point
 */

import React, {useState, useEffect} from "react";
import {StatusBar, LogBox, View, Text, ActivityIndicator, StyleSheet} from "react-native";
import {NavigationContainer} from "@react-navigation/native";
import {createStackNavigator} from "@react-navigation/stack";
import {Provider as PaperProvider, DefaultTheme} from "react-native-paper";
import {GestureHandlerRootView} from "react-native-gesture-handler";

// Screens
import LoginScreen from "./src/screens/LoginScreen";
import CameraScreen from "./src/screens/CameraScreen";
import InvoiceListScreen from "./src/screens/InvoiceListScreen";

// Types & Config
import {RootStackParamList} from "./src/types/invoice";
import {supabase, isAuthenticated} from "./src/config/supabase";

LogBox.ignoreLogs([
  "Non-serializable values were found in the navigation state",
]);

const Stack = createStackNavigator<RootStackParamList>();

const theme = {
  ...DefaultTheme,
  colors: {
    ...DefaultTheme.colors,
    primary: "#1976d2",
    accent: "#ff9800",
  },
};

// Splash Screen Component
const SplashScreen = () => (
  <View style={styles.splash}>
    <Text style={styles.splashTitle}>GestorIA RD</Text>
    <ActivityIndicator size="large" color="#1976d2" style={{marginTop: 20}} />
    <Text style={styles.splashText}>Cargando...</Text>
  </View>
);

function App(): React.JSX.Element {
  const [isAuthChecking, setIsAuthChecking] = useState(true);
  const [isUserAuthenticated, setIsUserAuthenticated] = useState(false);

  useEffect(() => {
    checkAuthState();

    const {data: {subscription}} = supabase.auth.onAuthStateChange((_event, session) => {
      console.log("Auth state changed:", _event, session?.user?.id);
      setIsUserAuthenticated(session !== null);
    });

    return () => {
      subscription.unsubscribe();
    };
  }, []);

  const checkAuthState = async () => {
    try {
      // Timeout de 5 segundos para evitar pantalla negra infinita
      const timeoutPromise = new Promise<boolean>((_, reject) => {
        setTimeout(() => reject(new Error("Timeout")), 5000);
      });

      const authPromise = isAuthenticated();
      
      const authenticated = await Promise.race([authPromise, timeoutPromise]);
      setIsUserAuthenticated(authenticated);
    } catch (error) {
      console.error("Error checking auth state:", error);
      // Si falla o timeout, ir al login
      setIsUserAuthenticated(false);
    } finally {
      setIsAuthChecking(false);
    }
  };

  // Mostrar splash screen mientras verifica auth
  if (isAuthChecking) {
    return (
      <GestureHandlerRootView style={{flex: 1}}>
        <SplashScreen />
      </GestureHandlerRootView>
    );
  }

  return (
    <GestureHandlerRootView style={{flex: 1}}>
      <PaperProvider theme={theme}>
        <StatusBar barStyle="dark-content" backgroundColor="#fff" />
        <NavigationContainer>
          <Stack.Navigator
            initialRouteName={isUserAuthenticated ? "InvoiceList" : "Login"}
            screenOptions={{
              headerStyle: {backgroundColor: theme.colors.primary},
              headerTintColor: "#fff",
              headerTitleStyle: {fontWeight: "bold"},
            }}>
            <Stack.Screen
              name="Login"
              component={LoginScreen}
              options={{headerShown: false}}
            />
            <Stack.Screen
              name="InvoiceList"
              component={InvoiceListScreen}
              options={{
                title: "Mis Facturas",
                headerLeft: () => null,
              }}
              initialParams={{groupId: "default"}}
            />
            <Stack.Screen
              name="Camera"
              component={CameraScreen}
              options={{
                title: "Escanear Factura",
                headerStyle: {backgroundColor: "#000"},
              }}
            />
          </Stack.Navigator>
        </NavigationContainer>
      </PaperProvider>
    </GestureHandlerRootView>
  );
}

const styles = StyleSheet.create({
  splash: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
    backgroundColor: "#fff",
  },
  splashTitle: {
    fontSize: 32,
    fontWeight: "bold",
    color: "#1976d2",
  },
  splashText: {
    marginTop: 10,
    fontSize: 16,
    color: "#666",
  },
});

export default App;
